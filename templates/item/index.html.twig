{% extends 'base.html.twig' %}
{% block head %}
{{ knp_pagination_rel_links(items) }}
{% endblock %}

{% block title %}{{ collection.name }}{% endblock %}

{% block body %}
{{ parent() }}
<div class="mx-5" data-controller="modal">
    <div class="row">
        <h1 class="text-center mb-5">{{ collection.name|upper }}</h1>
    </div>
    <div class="row my-2">
        <div class="col-12 p-0">
            <button 
                type="button"
                class="btn btn-primary showModal rounded-0"
                id="showModal"
                data-url="{{ absolute_url(path('app_item_add', {collectionId: collection.id})) }}"
                data-title="Ajouter un objet"
            >
                Ajouter
            </button>
        </div>
    </div>
    <div class="row mt-2">
        <table class="col-12 table table-hover table-responsive text-center table-bordered border-black align-middle">
            <thead class="table-dark border-dark">
                {% set hasRarities = collection.rarities|length > 0 %}
                <tr>
                    <th>{{ knp_pagination_sortable(items, 'Nom', 'i.name', {class: 'link-light link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover'}) }}</th>
                    <th>{{ knp_pagination_sortable(items, 'Référence', 'i.reference', {class: 'link-light link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover'}) }}</th>
                    {% if hasRarities %}
                        <th>{{ knp_pagination_sortable(items, 'Rareté', 'r.grade', {class: 'link-light link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover'}) }}</th>
                    {% endif %}
                    <th>{{ knp_pagination_sortable(items, 'Prix', 'i.price', {class: 'link-light link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover'}) }}</th>
                    <th>{{ knp_pagination_sortable(items, 'Ajouté/Modifié le', 'i.updatedAt', {class: 'link-light link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover'}) }}</th>
                    <th>{{ knp_pagination_sortable(items, 'Qualité', 'i.quality', {class: 'link-light link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover'}) }}</th>
                    <th style="width:10%;">{{ knp_pagination_sortable(items, 'Nombre', 'i.number', {class: 'link-light link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover'}) }}</th>
                    <th>Lien</th>
                    <th>Action</th>
                </tr>
                <tr>
                    <form data-controller="item" id="formFilter" action="{{ absolute_url(path('app_item_list', {collectionId: collection.id, categoryId: category.id})) }}" method="get">
                        {% set filterQuery = request.query.all('filter') %}
                        <th><input id="nameFilter" name="filter[name]" class="form-control rounded-0" type="text" value="{{ filterQuery.name ?? '' }}"></th>
                        <th><input id="referenceFilter" name="filter[reference]" class="form-control rounded-0" type="text" value="{{ filterQuery.reference ?? '' }}"></th>
                        {% if hasRarities %}
                            <th>
                                <select id="rarityFilter" name="filter[rarity]" class="form-select rounded-0">
                                    <option value="">---</option>
                                    {% for rarity in collection.rarities %}
                                        <option value="{{ rarity.id }}" {% if filterQuery.rarity is defined and filterQuery.rarity == rarity.id %}selected{% endif %}>{{ rarity.name }}</option>
                                    {% endfor %}
                                </select>
                            </th>
                        {% endif %}
                        <th>
                            <select id="priceFilter" name="filter[price]" class="form-select rounded-0">
                                <option value="">---</option>
                                {% for priceKey, priceValue in prices %}
                                    <option value="{{ priceKey }}" {% if filterQuery.price is defined and filterQuery.price == priceKey %}selected{% endif %}>{{ priceValue }}</option>
                                {% endfor %}
                            </select>
                        </th>
                        <th>
                        </th>
                        <th>
                            <select id="qualityFilter"name="filter[quality]" class="form-select rounded-0">
                                <option value="">---</option>
                                {% set qualityDefined = filterQuery.quality is defined %}
                                <option value="10" {% if qualityDefined and filterQuery.quality == '10' %}selected{% endif %}>Excellente</option>
                                <option value="8-9" {% if qualityDefined and filterQuery.quality == '8-9' %}selected{% endif %}>Très bonne</option>
                                <option value="6-7" {% if qualityDefined and filterQuery.quality == '6-7' %}selected{% endif %}>Bonne</option>
                                <option value="5" {% if qualityDefined and filterQuery.quality == '5' %}selected{% endif %}>Passable</option>
                                <option value="3-4" {% if qualityDefined and filterQuery.quality == '3-4' %}selected{% endif %}>Légèrement usée</option>
                                <option value="1-2" {% if qualityDefined and filterQuery.quality == '1-2' %}selected{% endif %}>Usée</option>
                                <option value="0" {% if qualityDefined and filterQuery.quality == '0' %}selected{% endif %}>Abimé</option>
                            </select>
                        </th>
                        <th>
                            <select id="numberFilter" name="filter[number]" class="form-select rounded-0">
                                <option value="">---</option>
                                {% set numberDefined = filterQuery.number is defined %}
                                <option value="1" {% if numberDefined and filterQuery.number == 1 %}selected{% endif %}>Plusieurs exemplaires</option>
                                <option value="0" {% if numberDefined and filterQuery.number is not null and filterQuery.number == 0 %}selected{% endif %}>Un seul exemplaire</option>
                            </select>
                        </th>
                        <th></th>
                        <th>
                            <a href="{{ path('app_item_list', {collectionId: collection.id, categoryId: category.id}) }}" class="btn btn-secondary btn-sm rounded-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/>
                                </svg>
                            </a>
                        </th>
                    </form>
                </tr>
            </thead>
            <tbody class="table-group-divider">
                {% for item in items %}
                    {% if item.quality == 10 %}
                        {% set qualityName = 'Excellente' %}
                    {% endif %}
                    {% if item.quality in range(8,9) %}
                        {% set qualityName = 'Très bonne' %}
                    {% endif %}
                    {% if item.quality in range(6,7) %}
                        {% set qualityName = 'Bonne' %}
                    {% endif %}
                    {% if item.quality == 5 %}
                        {% set qualityName = 'Passable' %}
                    {% endif %}
                    {% if item.quality in range(3,4) %}
                        {% set qualityName = 'Légèrement usée' %}
                    {% endif %}
                    {% if item.quality in range(1,2) %}
                        {% set qualityName = 'Usée' %}
                    {% endif %}
                    {% if item.quality == 0 %}
                        {% set qualityName = 'Abimé' %}
                    {% endif %}
                    
                    <tr>
                        <td>{{ item.name }}</td>
                        <td>{{ item.reference }}</td>
                        {% if hasRarities %}
                            <td>{% if item.rarity %}{{ item.rarity.name }}{% endif %}</td>
                        {% endif %}
                        <td>{{ item.price|format_currency('EUR', locale='fr') }}</td>
                        <td>{{ item.updatedAt ? item.updatedAt|date('d/m/Y') : item.createdAt|date('d/m/Y') }}</td>
                        <td>{{ qualityName }}</td>
                        <td style="width:2%;">{{ item.number }}</td>
                        <td>
                            {% if item.link %}
                                <a href="{{ item.link }}" target="_blank" class="btn btn-outline-primary btn-sm rounded-0">
                                    <i class="fa-solid fa-link"></i>
                                </a>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a class="btn btn-outline-primary btn-sm" href="{{ path('app_item_view', {id: item.id}) }}">
                                    <i class="fa-solid fa-eye"></i>
                                </a>
                                <button
                                    data-url="{{ absolute_url(path('app_item_edit', {collectionId: collection.id, itemId: item.id})) }}"
                                    data-title="{{ 'Modifier "' ~ item.name ~ '"' }}"
                                    class="btn btn-primary btn-sm showModal"
                                >
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <a href="{{ path('app_item_delete', {id: item.id}) }}" class="btn btn-danger btn-sm">
                                    <i class="fa-solid fa-trash-can"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                {% else %}
                    <tr><td colspan="9">Il n'y a pas de carte.</td></tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="navigation">
            {{ knp_pagination_render(items) }}
        </div>
    </div>
    {% include "Modal/modal.html.twig" %}
</div>
{% endblock %}